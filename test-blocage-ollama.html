<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostic - Blocage apr√®s g√©n√©ration Ollama</title>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .diagnostic-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            background: #f8f9fa;
        }
        
        .diagnostic-section h2 {
            color: #0077b5;
            margin-bottom: 15px;
        }
        
        .test-btn {
            background: #0077b5;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin: 10px 10px 10px 0;
            transition: all 0.3s ease;
        }
        
        .test-btn:hover {
            background: #005885;
            transform: translateY(-1px);
        }
        
        .logs {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin: 15px 0;
        }
        
        .post-content {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            min-height: 100px;
            line-height: 1.6;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-indicator.loading {
            background: #f39c12;
            animation: pulse 1s infinite;
        }
        
        .status-indicator.success {
            background: #27ae60;
        }
        
        .status-indicator.error {
            background: #e74c3c;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .progress-steps {
            list-style: none;
            padding: 0;
        }
        
        .progress-steps li {
            padding: 10px;
            margin: 5px 0;
            border-left: 4px solid #ddd;
            background: #f8f9fa;
            border-radius: 0 8px 8px 0;
        }
        
        .progress-steps li.current {
            border-left-color: #f39c12;
            background: #fff3cd;
        }
        
        .progress-steps li.completed {
            border-left-color: #27ae60;
            background: #d4edda;
        }
        
        .progress-steps li.error {
            border-left-color: #e74c3c;
            background: #f8d7da;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Diagnostic - Blocage apr√®s g√©n√©ration Ollama</h1>
        
        <div class="diagnostic-section">
            <h2>üö® Probl√®me Identifi√©</h2>
            <p><strong>Sympt√¥me :</strong> Blocage apr√®s l'affichage du post g√©n√©r√© par Ollama</p>
            <p><strong>Impact :</strong> L'interface se fige, les boutons deviennent non-fonctionnels</p>
        </div>
        
        <div class="diagnostic-section">
            <h2>üîç Tests de Diagnostic</h2>
            
            <button class="test-btn" onclick="simulateOllamaGeneration()">
                ü§ñ Simuler G√©n√©ration Ollama
            </button>
            
            <button class="test-btn" onclick="testDisplayProcess()">
                üé® Tester Processus d'Affichage
            </button>
            
            <button class="test-btn" onclick="testScrollBehavior()">
                üìú Tester Comportement de Scroll
            </button>
            
            <button class="test-btn" onclick="testNotifications()">
                üì¢ Tester Notifications
            </button>
            
            <button class="test-btn" onclick="runFullDiagnostic()">
                üî¨ Diagnostic Complet
            </button>
        </div>

        <div class="diagnostic-section">
            <h2>üìã √âtapes du Processus</h2>
            <ul class="progress-steps" id="progressSteps">
                <li id="step1">1. G√©n√©ration par Ollama</li>
                <li id="step2">2. R√©ception du contenu</li>
                <li id="step3">3. Validation du contenu</li>
                <li id="step4">4. Formatage HTML</li>
                <li id="step5">5. Insertion dans le DOM</li>
                <li id="step6">6. Affichage de la section</li>
                <li id="step7">7. Scroll vers le r√©sultat</li>
                <li id="step8">8. Activation des boutons</li>
                <li id="step9">9. Notification de succ√®s</li>
                <li id="step10">10. Finalisation</li>
            </ul>
        </div>

        <div class="diagnostic-section">
            <h2>üìù Contenu de Test</h2>
            <div class="post-content" id="testPostContent">
                Le contenu g√©n√©r√© appara√Ætra ici...
            </div>
        </div>

        <div class="diagnostic-section">
            <h2>üìã Logs de Diagnostic</h2>
            <div class="logs" id="diagnosticLogs">
                Console de diagnostic initialis√©e...<br>
            </div>
        </div>
        
        <div class="diagnostic-section">
            <h2>‚úÖ Solutions Appliqu√©es</h2>
            <ul>
                <li>‚úÖ <strong>Logs de Debug D√©taill√©s</strong> - Tra√ßage de chaque √©tape</li>
                <li>‚úÖ <strong>Gestion d'Erreur Robuste</strong> - Try-catch √† tous les niveaux</li>
                <li>‚úÖ <strong>setTimeout pour Op√©rations Async</strong> - √âvite les blocages</li>
                <li>‚úÖ <strong>Fallback pour le Scroll</strong> - Scroll sans animation si erreur</li>
                <li>‚úÖ <strong>R√©cup√©ration d'Erreur</strong> - Affichage minimal en cas d'√©chec</li>
                <li>‚úÖ <strong>Notifications S√©par√©es</strong> - √âvite les conflits</li>
            </ul>
        </div>
    </div>

    <script>
        class OllamaBlocageDiagnostic {
            constructor() {
                this.logs = document.getElementById('diagnosticLogs');
                this.testPostContent = document.getElementById('testPostContent');
                this.currentStep = 0;
                this.steps = [
                    'step1', 'step2', 'step3', 'step4', 'step5',
                    'step6', 'step7', 'step8', 'step9', 'step10'
                ];
                
                this.init();
            }
            
            init() {
                this.log('üöÄ Diagnostic du blocage Ollama initialis√©');
            }
            
            log(message) {
                const timestamp = new Date().toLocaleTimeString();
                console.log(message);
                this.logs.innerHTML += `[${timestamp}] ${message}<br>`;
                this.logs.scrollTop = this.logs.scrollHeight;
            }
            
            updateStep(stepIndex, status = 'current') {
                // R√©initialiser tous les steps
                this.steps.forEach((stepId, index) => {
                    const element = document.getElementById(stepId);
                    if (element) {
                        element.className = '';
                        if (index < stepIndex) {
                            element.classList.add('completed');
                        } else if (index === stepIndex) {
                            element.classList.add(status);
                        }
                    }
                });
            }
            
            async simulateOllamaGeneration() {
                this.log('ü§ñ === SIMULATION G√âN√âRATION OLLAMA ===');
                this.currentStep = 0;
                
                try {
                    // √âtape 1: G√©n√©ration par Ollama
                    this.updateStep(0, 'current');
                    this.log('1Ô∏è‚É£ D√©but de la g√©n√©ration Ollama...');
                    await this.delay(1000);
                    
                    // √âtape 2: R√©ception du contenu
                    this.updateStep(1, 'current');
                    this.log('2Ô∏è‚É£ R√©ception du contenu...');
                    const content = this.generateMockContent();
                    await this.delay(500);
                    
                    // √âtape 3: Validation du contenu
                    this.updateStep(2, 'current');
                    this.log('3Ô∏è‚É£ Validation du contenu...');
                    if (!content || !content.trim()) {
                        throw new Error('Contenu invalide');
                    }
                    await this.delay(200);
                    
                    // √âtape 4: Formatage HTML
                    this.updateStep(3, 'current');
                    this.log('4Ô∏è‚É£ Formatage HTML...');
                    const formattedContent = this.formatContent(content);
                    await this.delay(300);
                    
                    // √âtape 5: Insertion dans le DOM
                    this.updateStep(4, 'current');
                    this.log('5Ô∏è‚É£ Insertion dans le DOM...');
                    this.testPostContent.innerHTML = formattedContent;
                    await this.delay(200);
                    
                    // √âtape 6: Affichage de la section
                    this.updateStep(5, 'current');
                    this.log('6Ô∏è‚É£ Affichage de la section...');
                    this.testPostContent.style.display = 'block';
                    await this.delay(200);
                    
                    // √âtape 7: Scroll vers le r√©sultat
                    this.updateStep(6, 'current');
                    this.log('7Ô∏è‚É£ Scroll vers le r√©sultat...');
                    await this.testScrollWithFallback();
                    
                    // √âtape 8: Activation des boutons
                    this.updateStep(7, 'current');
                    this.log('8Ô∏è‚É£ Activation des boutons...');
                    await this.delay(200);
                    
                    // √âtape 9: Notification de succ√®s
                    this.updateStep(8, 'current');
                    this.log('9Ô∏è‚É£ Notification de succ√®s...');
                    await this.delay(300);
                    
                    // √âtape 10: Finalisation
                    this.updateStep(9, 'completed');
                    this.log('üéâ Processus termin√© avec succ√®s !');
                    
                } catch (error) {
                    this.updateStep(this.currentStep, 'error');
                    this.log(`‚ùå ERREUR √† l'√©tape ${this.currentStep + 1}: ${error.message}`);
                    this.log(`Stack trace: ${error.stack}`);
                }
            }
            
            async testScrollWithFallback() {
                try {
                    this.log('üìú Test de scroll avec animation...');
                    
                    // Test du scroll smooth
                    this.testPostContent.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                    
                    await this.delay(500);
                    this.log('‚úÖ Scroll smooth r√©ussi');
                    
                } catch (scrollError) {
                    this.log(`‚ö†Ô∏è Erreur scroll smooth: ${scrollError.message}`);
                    this.log('üîÑ Tentative de fallback...');
                    
                    try {
                        // Fallback sans animation
                        this.testPostContent.scrollIntoView(false);
                        this.log('‚úÖ Scroll fallback r√©ussi');
                    } catch (fallbackError) {
                        this.log(`‚ùå Erreur scroll fallback: ${fallbackError.message}`);
                        throw fallbackError;
                    }
                }
            }
            
            generateMockContent() {
                return `üöÄ **Innovation et IA : Le futur de la vaccination**

En tant que professionnel de la sant√© publique, je suis fascin√© par l'impact transformateur de l'intelligence artificielle sur nos campagnes de vaccination.

üîç **Comment l'IA r√©volutionne la vaccination :**
‚Ä¢ Pr√©diction des besoins en vaccins avec une pr√©cision de 95%
‚Ä¢ Optimisation des cha√Ænes logistiques pour une distribution efficace
‚Ä¢ Identification des populations √† risque pour un ciblage pr√©cis

üí° **Mon exp√©rience personnelle :**
L'impl√©mentation de l'IA dans notre programme de vaccination a permis d'augmenter notre taux de couverture de 23% en seulement 6 mois.

#IA #Sant√©Publique #Innovation`;
            }
            
            formatContent(content) {
                return content
                    .replace(/\n\n/g, '</p><p>') // Paragraphes
                    .replace(/\n/g, '<br>') // Retours √† la ligne
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Gras
                    .replace(/\*(.*?)\*/g, '<em>$1</em>') // Italique
                    .replace(/#(\w+)/g, '<span style="color: #0077b5; font-weight: 600; background: rgba(0,119,181,0.1); padding: 2px 6px; border-radius: 4px;">#$1</span>'); // Hashtags
            }
            
            async testDisplayProcess() {
                this.log('üé® === TEST PROCESSUS D\'AFFICHAGE ===');
                
                try {
                    this.log('üîÑ Test requestAnimationFrame...');
                    
                    await new Promise((resolve, reject) => {
                        const startTime = performance.now();
                        
                        requestAnimationFrame(() => {
                            try {
                                const endTime = performance.now();
                                this.log(`‚úÖ requestAnimationFrame OK (${endTime - startTime}ms)`);
                                
                                // Test d'op√©rations DOM intensives
                                for (let i = 0; i < 100; i++) {
                                    const div = document.createElement('div');
                                    div.textContent = `Test ${i}`;
                                    document.body.appendChild(div);
                                    document.body.removeChild(div);
                                }
                                
                                this.log('‚úÖ Op√©rations DOM intensives OK');
                                resolve();
                                
                            } catch (error) {
                                this.log(`‚ùå Erreur dans requestAnimationFrame: ${error.message}`);
                                reject(error);
                            }
                        });
                        
                        // Timeout de s√©curit√©
                        setTimeout(() => {
                            reject(new Error('Timeout requestAnimationFrame'));
                        }, 5000);
                    });
                    
                } catch (error) {
                    this.log(`‚ùå Erreur test d'affichage: ${error.message}`);
                }
            }
            
            async testScrollBehavior() {
                this.log('üìú === TEST COMPORTEMENT DE SCROLL ===');
                
                try {
                    const testDiv = document.createElement('div');
                    testDiv.style.cssText = `
                        height: 200px;
                        background: #e3f2fd;
                        margin: 20px 0;
                        padding: 20px;
                        border-radius: 8px;
                    `;
                    testDiv.textContent = 'Zone de test pour le scroll';
                    this.testPostContent.appendChild(testDiv);
                    
                    // Test scroll smooth
                    this.log('üîÑ Test scroll smooth...');
                    testDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    await this.delay(1000);
                    this.log('‚úÖ Scroll smooth OK');
                    
                    // Test scroll instant
                    this.log('üîÑ Test scroll instant...');
                    testDiv.scrollIntoView(false);
                    await this.delay(200);
                    this.log('‚úÖ Scroll instant OK');
                    
                    // Nettoyage
                    this.testPostContent.removeChild(testDiv);
                    
                } catch (error) {
                    this.log(`‚ùå Erreur test de scroll: ${error.message}`);
                }
            }
            
            async testNotifications() {
                this.log('üì¢ === TEST NOTIFICATIONS ===');
                
                try {
                    // Test notification simple
                    this.log('üîî Test notification simple...');
                    this.showTestNotification('Test notification', 'info');
                    await this.delay(1000);
                    
                    // Test notification avec d√©lai
                    this.log('‚è∞ Test notification avec d√©lai...');
                    setTimeout(() => {
                        this.showTestNotification('Notification diff√©r√©e', 'success');
                    }, 500);
                    await this.delay(1500);
                    
                    this.log('‚úÖ Tests de notifications OK');
                    
                } catch (error) {
                    this.log(`‚ùå Erreur test notifications: ${error.message}`);
                }
            }
            
            showTestNotification(message, type) {
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 10px 15px;
                    background: ${type === 'success' ? '#27ae60' : type === 'error' ? '#e74c3c' : '#3498db'};
                    color: white;
                    border-radius: 6px;
                    z-index: 10000;
                    font-size: 14px;
                `;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 3000);
            }
            
            async runFullDiagnostic() {
                this.log('üî¨ === DIAGNOSTIC COMPLET ===');
                
                try {
                    await this.testDisplayProcess();
                    await this.delay(500);
                    
                    await this.testScrollBehavior();
                    await this.delay(500);
                    
                    await this.testNotifications();
                    await this.delay(500);
                    
                    await this.simulateOllamaGeneration();
                    
                    this.log('üéâ DIAGNOSTIC COMPLET TERMIN√â');
                    
                } catch (error) {
                    this.log(`‚ùå Erreur diagnostic complet: ${error.message}`);
                }
            }
            
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }
        
        // Fonctions globales
        function simulateOllamaGeneration() {
            window.diagnostic.simulateOllamaGeneration();
        }
        
        function testDisplayProcess() {
            window.diagnostic.testDisplayProcess();
        }
        
        function testScrollBehavior() {
            window.diagnostic.testScrollBehavior();
        }
        
        function testNotifications() {
            window.diagnostic.testNotifications();
        }
        
        function runFullDiagnostic() {
            window.diagnostic.runFullDiagnostic();
        }
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            window.diagnostic = new OllamaBlocageDiagnostic();
        });
    </script>
</body>
</html>
